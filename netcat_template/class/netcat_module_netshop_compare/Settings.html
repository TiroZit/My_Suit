<?php

$nc_core = nc_core::get_object();
$nc_netshop = nc_netshop::get_instance();
$nc_input = $nc_core->input;
$cc_settings = nc_get_visual_settings($cc_env['Sub_Class_ID']);

// Удаление элемента
$do = $nc_input->fetch_post('do');
if ($do == 'remove') {
    $class_id = (int)$nc_input->fetch_post('class_id');
    $item_id = (int)$nc_input->fetch_post('item_id');
    $item = null;
    try {
        $item = nc_netshop_item::by_id($class_id, $item_id);
    } catch (Exception $e) {
        $item = null;
    }
    if ($item) {
        $nc_netshop->goodslist_compare->remove($item_id, $class_id);
        header("Refresh:0");
        exit;
    }
}

// Выборка товаров для отображения
$_goods = $nc_netshop->goodslist_compare->get_all("DESC");

$goods = array();
$components = array();
if (count($_goods)) {
    foreach ($_goods as $index => $item) {
        try {
            $item = nc_netshop_item::by_id($item['Class_ID'], $item['Item_ID']);
        } catch (Exception $e) {
            $item = null;
        }
        if (!$item || !$item['Sub_Class_ID']) {
            continue;
        }
        $components[$item['Class_ID']] = true;
        $goods[$index] = $item;
    }
}
$goods_count = count($goods);
$components = array_keys($components);
$fields = array();
if ($goods_count) {
    $fields = nc_get_same_fields($components, array(
        'SalesNotes',
        'Name',
        'VariantName',
        'Vendor',
        'Article',
        'Description',
        'Details',
        'Image',
        'BigImage',
        'Slider',
        'Price',
        'Currency',
        'PriceMinimum',
        'CurrencyMinimum',
        'Units',
        'StockUnits',
        'TopSellingMultiplier',
        'TopSellingAddition',
        'VAT',
        'ItemID',
        'ImportSourceID',
        'Tag',
        'Type',
        'Color',
        'Size',
        'SetType',
        'RateTotal',
        'RateCount',
        'ItemSet_ID',
        'DescriptionTitle'
    ));
}

$size = $cc_settings['object_ratio'];
if ($cc_settings['object_ratio'] === 'custom') {
    $size = $cc_settings['custom_ratio'];
}
list($w, $h) = explode(":", str_replace(",", ".", $size));
if ((float)$w > 0) {
    $padding_top = str_replace(",", ".", ($h / $w) * 100) . "%";
} else {
    $padding_top = '100%';
}
$goods_item_styles = array();
$goods_item_styles[] = "--tpl-object-item--image-padding-top: " . $padding_top;
$goods_item_styles[] = "--tpl-object-item--image-fit: ".$cc_settings['image_format'];
$goods_item_styles = " style='" . implode(";", $goods_item_styles) . "'";

if (!function_exists('nc_netshop_goods_scripts')) {
    function nc_netshop_goods_scripts() {
        ob_start(); ?>
        <script>
            function nc_netshop_cart($this) {
                var btn = jQuery($this), form = jQuery($this).closest('form');
                jQuery.post(form.attr('action'), form.serialize() + "&json=1", function (response) {
                    nc_event_dispatch('ncNetshopCartUpdate', {
                        cart: response,
                        form: form,
                        modal: true
                    });
                    btn.html('В корзине');
                }, 'json');
                return false;
            }
        </script>
        <?php return ob_get_clean();
    }
}